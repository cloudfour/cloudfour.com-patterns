import { Story, Canvas, Meta } from '@storybook/addon-docs';
import { useEffect } from '@storybook/client-api';
import { makeTwigInclude } from '../../make-twig-include';
import template from './subscribe.twig';
import { initSubscribe } from './subscribe.ts';
// Helper function to initialize toggling button JS
const templateStory = (args) => {
  useEffect(() => {
    const templateEls = [...document.querySelectorAll('.js-subscribe')].map(
      (templateEl) => initSubscribe(templateEl)
    );
    return () => {
      for (const templateEl of templateEls) templateEl.destroy();
    };
  });
  return template(args);
};

<Meta
  title="Components/Subscribe"
  argTypes={{
    form_id: {
      type: { name: 'string', required: true },
      description: 'The ID used for the email subscription form',
    },
    class: {
      type: 'string',
      description: 'CSS class(es) to add to the root element',
    },
    heading_tag: {
      type: 'string',
      defaultValue: 'h2',
      description: 'The heading value for the headings',
      options: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
      control: 'select',
    },
    never_miss_article_heading: {
      type: 'string',
      defaultValue: 'Never miss an article!',
    },
    weekly_digests_btn_label: {
      type: 'string',
      defaultValue: 'Get Weekly Digests',
    },
    weekly_digests_heading: {
      type: 'string',
      defaultValue: 'Get Weekly Digests',
    },
    email_input_placeholder: {
      type: 'string',
      defaultValue: 'Your Email Address',
    },
    submit_btn_label: {
      type: 'string',
      defaultValue: 'Subscribe',
    },
  }}
/>

# Subscribe

The Subscribe component provides the UI to subscribe to notifications and/or email weekly digests.

This component embeds the [Button Swap component](?path=/docs/components-button-swap--default-story) for the "Get Notifications" button.

<Canvas>
  <Story
    inline={false}
    name="Default"
    args={{
      form_id: 'example-demo',
    }}
    parameters={{
      docs: {
        source: {
          code: makeTwigInclude(
            '@cloudfour/components/subscribe/subscribe.twig',
            {
              form_id: 'example-demo',
            }
          ),
        },
      },
    }}
  >
    {(args) => templateStory(args)}
  </Story>
</Canvas>

## Template Properties

### Required

| property  | type   | default | description                                                          |
| --------- | ------ | ------- | -------------------------------------------------------------------- |
| `form_id` | string | `''`    | Appends this value to the weekly digest form `id`, should be unique. |

### Optional

| property                                 | type   | default                                 | description                                                                                                     |
| ---------------------------------------- | ------ | --------------------------------------- | --------------------------------------------------------------------------------------------------------------- |
| `class`                                  | string | `''`                                    | Appends a CSS class(es) to the root `.c-subscribe` element.                                                     |
| `form_action`                            | string | TBD                                     | The subscription form `action` value                                                                            |
| `heading_tag`                            | string | `'h2'`                                  | The heading value (`h1`-`h6`)                                                                                   |
| `never_miss_article_heading`             | string | `'Never miss an article!'`              | The default heading                                                                                             |
| `notifications_btn_class`                | string | `''`                                    | Appends a CSS class(es) to the "Get notifications" button                                                       |
| `notifications_btn_initial_label`        | string | `'Notifications have been turned off.'` | See [Button Swap `initial_label`](?path=/docs/components-button-swap--default-story#template-properties)        |
| `notifications_btn_initial_visual_label` | string | `'Get notifications'`                   | See [Button Swap `initial_visual_label`](?path=/docs/components-button-swap--default-story#template-properties) |
| `notifications_btn_swapped_label`        | string | `'Notifications have been turned on.'`  | See [Button Swap `swapped_label`](?path=/docs/components-button-swap--default-story#template-properties)        |
| `notifications_btn_swapped_visual_label` | string | `'Turn off notifications'`              | See [Button Swap `swapped_visual_label`](?path=/docs/components-button-swap--default-story#template-properties) |
| `weekly_digests_btn_class`               | string | `''`                                    | Appends a CSS class(es) to the "Weekly Digests" button                                                          |
| `weekly_digests_btn_label`               | string | `'Get Weekly Digests'`                  | The "Weekly Digests" button label                                                                               |
| `weekly_digests_btn_icon`                | string | `'envelope' `                           | The "Weekly Digests" button [icon](?path=/docs/design-icons--page)                                              |
| `weekly_digests_heading`                 | string | `'Get Weekly Digests'`                  | The subscription form heading                                                                                   |
| `email_input_label`                      | string | `'Email'`                               | The email input label                                                                                           |
| `email_input_placeholder`                | string | `'Your Email Address'`                  | The email input placeholder text                                                                                |
| `submit_btn_label`                       | string | `'Subscribe'`                           | The subscription form submit button label                                                                       |

## JavaScript

The Subscribe component UX can be progressively enhanced using JavaScript in the following ways:

- A one second form hide delay is added when `:focus` is moved away from the Subscribe component elements
- The form can be hidden by pressing the <kbd>Escape</kbd> key

### Syntax

```js
initSubscribe(subscriptionChoicesEl);
```

### Parameters

#### `subscriptionChoicesEl`

The Subscribe component `.js-subscribe` root element.

### Return value

An object with a `destroy` function that removes all event listeners added by this component.

```js
{
  destroy: () => void
}
```

### Examples

#### Single Subscribe component on the page

```js
// Initialize
const subscriptionChoicesEl = initSubscribe(
  document.querySelector('.js-subscribe')
);

// Remove all event listeners
subscriptionChoicesEl.destroy();
```

#### Multiple Subscribe components on the page

```js
// Initialize
const subscriptionChoiceEls = [
  ...document.querySelectorAll('.js-subscribe'),
].map((subscriptionChoiceEl) => initSubscribe(subscriptionChoiceEl));

// Remove all event listeners
for (const subscriptionChoiceEl of subscriptionChoiceEls) {
  subscriptionChoiceEl.destroy();
}
```

### Note

You will need to initialize the "Get Notifications" button as well, see the
[Button Swap component](?path=/docs/components-button-swap--default-story#javascript)
for initialization docs.
