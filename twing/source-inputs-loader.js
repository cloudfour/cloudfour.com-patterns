const { relative } = require('path');

// This loader changes the functions that are generated by importing .twig files
// It makes the functions attach the arguments and twig file path to a global __twig__inputs__ global
// __twig__inputs__ is a map between the output HTML and and objects with the arguments and input paths
// __twig__inputs__ is used in transformSource in .storybook/preview.js to generate the twig source code previews

module.exports = function (source) {
  // Change it from an absolute path to a path starting with @cloudfour/
  const path = relative(this.rootContext, this.resourcePath).replace(
    /^src\//,
    '@cloudfour/'
  );
  return source.replace(
    `return template.render(context)`,
    `const rendered = template.render(context);
     const inputs = window.__twig_inputs__ || (window.__twig_inputs__ = new Map());
     inputs.set(
       rendered,
       { path: ${JSON.stringify(path)}, args: context }
     );
     return rendered;`
  );
};
