import { Story, Canvas, Meta } from '@storybook/addon-docs/blocks';
import { makeComment } from './demo/data.ts';
import template from './comment.twig';
import { initComments } from './comment.ts';
import { useEffect } from '@storybook/client-api';
const tyler = {
  name: 'Tyler Sticka',
  link: 'https://cloudfour.com/is/tyler',
};

<Meta
  title="Components/Comment"
  argTypes={{
    isLoggedIn: {
      type: { name: 'boolean' },
      defaultValue: false,
    },
    allowReplies: {
      type: { name: 'boolean' },
      defaultValue: false,
    },
  }}
/>

# Comment

Displays a single comment in a comment thread, optionally with replies. Multiple comments can be displayed within [a Rhythm layout object](/docs/objects-rhythm--default-story).

## Status

This component is still a work in progress. The following features are still in development:

- Integrating the comment reply form.
- Finalizing this pattern's blocks and properties for theme integration.

## Single

At minimum, a single comment consists of:

- Author name
- Author avatar
- Comment content (HTML)
- Publication date
- Permalink to the comment

This information may be passed to the component as a `comment` object matching the structure of a [Timber comment](https://timber.github.io/docs/reference/timber-comment/).

<Canvas>
  <Story name="Single">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({
          allow_replies: args.allowReplies,
        }),
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## Role badges

It is helpful for context within a discussion to know when a commentor is the original post author or a Cloud Four team member. The mechanics of this feature are still in development, but these stories show how these roles should appear using [the Badge component](/docs/components-badge--basic).

<Canvas>
  <Story name="Role: Author">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({
          allowReplies: args.allowReplies,
        }),
        demo_post_author: true,
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

<Canvas>
  <Story name="Role: Cloud Four">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({
          allowReplies: args.allowReplies,
        }),
        demo_cloud_four_member: true,
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## Unapproved

If `comment.approved` is not `true`, an [Alert](/docs/components-alert--basic) will indicate that the comment is not yet approved.

<Canvas>
  <Story name="Unapproved">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({
          approved: false,
          allowReplies: args.allowReplies,
        }),
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## With source

Additionally, a `source` object may be passed to the template consisting of a `url` and `name`. This is helpful if integrating [webmentions](https://indieweb.org/Webmention) into comment threads.

<Canvas>
  <Story name="With source">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({ allowReplies: args.allowReplies }),
        source: {
          url: 'https://twitter.com/smashingmag/status/1371521325236416516',
          name: 'twitter.com',
        },
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## With reply button

You can set `allow_replies` to `true` in order to add a reply button that toggles a [Comment Form](/docs/components-comment-form--reply).

If the user is logged in, you should pass in `logged_in_user` and `log_out_url` properties that match the [template properties of Comment Forms](/docs/components-comment-form--reply#template-properties).

<Canvas>
  <Story name="With reply button" args={{ allowReplies: true }}>
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({ allowReplies: args.allowReplies }),
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## With reply thread

If a `comment` contains an array of `children`, they will be display in the footer of the original comment. A vertical line is used to visually associate the replies with the original comment. If the parent comment is contained within [a Rhythm layout object](/docs/objects-rhythm--default-story),the child comments will inherit that spacing.

While it is theoretically possible to infinitely nest `children`, it's recommended to limit the depth to a single level. This is for two reasons:

- Increasingly narrow comments will become difficult to read on narrow screens.
- The heading levels for comment threads increment up to a maximum of six (since HTML only provides six heading levels). This means that levels beyond that will be harder to traverse for user agents navigating via the document outline.

<Canvas>
  <Story name="With reply thread">
    {(args) => {
      useEffect(() => {
        initComments();
      });
      return template({
        comment: makeComment({ replies: 2, allowReplies: args.allowReplies }),
        logged_in_user: args.isLoggedIn ? tyler : null,
        log_out_url: '/logout',
      });
    }}
  </Story>
</Canvas>

## Template Properties

- `comment`: A comment object containing the following properties:
  - `ID`: A unique numerical ID
  - `link`: A hash URL such as `#comment-100`
  - `date`: The date of the comment
  - `avatar`: A url to the commenter's avatar.
  - `author`: An object containing the following properties:
    - `name`: The commenter's name
  - `comment_content`: The comment content
  - `is_child`: Whether a comment is a child of another comment
  - `children`: Nested responses to the comment
  - `approved`: Whether the comment is approved
  - `allow_replies`: A boolean property that controls whether to show a reply button and form
- `logged_in_user`: [user object](https://timber.github.io/docs/reference/timber-user/#properties) of the type:
  ```ts
  {
    name: string | () => string;
    link: string | () => string;
  }
  ```
- `log_out_url`: URL used for log out link.
- `source`: An optional object containing a `url` and `name` for the comment source.

## JavaScript Instructions

You can run `initComments` to initialize all comments on a page:

```js
// Depending on how you're consuming this project, the script is likely at
// a different location.
import { initComments } from './comment.ts';
initComments();
```
